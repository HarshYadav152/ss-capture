name: Build and Release Extension

on:
  push:
    branches:
      - test-workflow
    paths:
      - 'ss-capture/src/manifest.json'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ss-capture

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for changelog

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ss-capture/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Get version from manifest
        id: get_version
        run: |
          VERSION=$(node -p "require('./src/manifest.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "::notice::Detected version: $VERSION"

      - name: Check if release exists
        id: check_release
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ env.VERSION }}"; then
            echo "::warning::Release v${{ env.VERSION }} already exists. Skipping..."
            echo "exists=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog for current version
        if: steps.check_release.outputs.exists == 'false'
        id: changelog
        run: |
          cd ..
          # Extract changelog section for current date
          CHANGELOG_CONTENT=$(awk '/^## \[2026-01-22\]/,/^## \[/' CHANGELOG.md | sed '$d' | sed '1d')
          
          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="No changelog entry found for this version."
          fi
          
          # Create release notes
          cat > release_notes.md << 'EOF'
          ## ðŸŽ‰ What's New in SS Capture v${{ env.VERSION }}
          
          SS Capture is a powerful browser extension for capturing, editing, and managing screenshots across Chrome, Firefox, and Edge browsers.
          
          ### ðŸ“¦ Download the Extension
          
          Choose your browser and download the appropriate extension file below:
          
          - **Chrome**: `ss-capture-chrome-v${{ env.VERSION }}.zip`
          - **Firefox**: `ss-capture-firefox-v${{ env.VERSION }}.zip`
          - **Edge**: `ss-capture-edge-v${{ env.VERSION }}.zip`
          
          ### ðŸ“‹ Installation Instructions
          
          #### Chrome/Edge:
          1. Download the `.zip` file for your browser
          2. Extract the contents
          3. Open `chrome://extensions/` (Chrome) or `edge://extensions/` (Edge)
          4. Enable "Developer mode"
          5. Click "Load unpacked" and select the extracted folder
          
          #### Firefox:
          1. Download the Firefox `.zip` file
          2. Open `about:debugging#/runtime/this-firefox`
          3. Click "Load Temporary Add-on"
          4. Select the `.zip` file
          
          ### ðŸŽ¯ Key Features
          
          - ðŸ“¸ Multiple capture modes (Full page, Visible area, Selected element)
          - âœï¸ Built-in screenshot editor with annotations
          - ðŸŽ¨ Drawing tools, text, shapes, and arrows
          - ðŸ”’ Privacy blur/pixelate tool
          - ðŸ“‹ One-click copy to clipboard
          - âŒ¨ï¸ Keyboard shortcuts (Alt+Shift+S)
          - ðŸŒ“ Dark/Light theme support
          - ðŸ’¾ Multiple save formats
          
          ### ðŸ“ Changes in This Release
          
          EOF
          
          echo "$CHANGELOG_CONTENT" >> release_notes.md
          
          cat >> release_notes.md << 'EOF'
          
          ### ðŸ”— Useful Links
          
          - [Documentation](https://github.com/${{ github.repository }})
          - [Report Issues](https://github.com/${{ github.repository }}/issues)
          - [Contribute](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)
          
          ### â­ Support the Project
          
          If you find SS Capture useful, please consider:
          - â­ Starring the repository
          - ðŸ› Reporting bugs
          - ðŸ’¡ Suggesting new features
          - ðŸ¤ Contributing to the project
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md
          EOF
          
          cat release_notes.md

      - name: Validate extension
        if: steps.check_release.outputs.exists == 'false'
        run: npm run validate

      - name: Build all browsers
        if: steps.check_release.outputs.exists == 'false'
        run: npm run build

      - name: Create ZIP packages
        if: steps.check_release.outputs.exists == 'false'
        run: npm run zip

      - name: Verify artifacts exist
        if: steps.check_release.outputs.exists == 'false'
        run: |
          ls -lh dist/
          test -f dist/chrome-extension.zip
          test -f dist/firefox-extension.zip
          test -f dist/edge-extension.zip
          echo "::notice::All extension packages created successfully"

      - name: Rename artifacts
        if: steps.check_release.outputs.exists == 'false'
        run: |
          mv dist/chrome-extension.zip dist/ss-capture-chrome-v${{ env.VERSION }}.zip
          mv dist/firefox-extension.zip dist/ss-capture-firefox-v${{ env.VERSION }}.zip
          mv dist/edge-extension.zip dist/ss-capture-edge-v${{ env.VERSION }}.zip
          ls -lh dist/
          echo "::notice::Artifacts renamed with version numbers"

      - name: Create Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: SS Capture v${{ env.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ss-capture/dist/ss-capture-chrome-v${{ env.VERSION }}.zip
            ss-capture/dist/ss-capture-firefox-v${{ env.VERSION }}.zip
            ss-capture/dist/ss-capture-edge-v${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: steps.check_release.outputs.exists == 'false'
        run: |
          echo "::notice::ðŸŽ‰ Release v${{ env.VERSION }} created successfully!"
          echo "::notice::ðŸ“¦ Chrome: ss-capture-chrome-v${{ env.VERSION }}.zip"
          echo "::notice::ðŸ“¦ Firefox: ss-capture-firefox-v${{ env.VERSION }}.zip"
          echo "::notice::ðŸ“¦ Edge: ss-capture-edge-v${{ env.VERSION }}.zip"